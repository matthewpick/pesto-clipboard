name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  attestations: write
  id-token: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Resolve Swift Package Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project PestoClipboard/PestoClipboard.xcodeproj \
            -scheme PestoClipboard

      - name: Build Release
        run: |
          xcodebuild build \
            -project PestoClipboard/PestoClipboard.xcodeproj \
            -scheme PestoClipboard \
            -configuration Release \
            -derivedDataPath build \
            -arch arm64 \
            -arch x86_64 \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          APP_PATH="build/Build/Products/Release/Pesto Clipboard.app"
          DMG_NAME="PestoClipboard-${{ steps.version.outputs.VERSION }}.dmg"

          # Create a temporary directory for DMG contents
          mkdir -p dmg-contents
          cp -R "$APP_PATH" dmg-contents/

          # Create the DMG
          create-dmg \
            --volname "Pesto Clipboard" \
            --volicon "PestoClipboard/PestoClipboard/Assets.xcassets/AppIcon.appiconset/icon_512x512.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Pesto Clipboard.app" 150 185 \
            --hide-extension "Pesto Clipboard.app" \
            --app-drop-link 450 185 \
            "$DMG_NAME" \
            dmg-contents/ \
            || true  # create-dmg returns non-zero even on success sometimes

          # Verify DMG was created
          if [ ! -f "$DMG_NAME" ]; then
            echo "DMG creation failed, trying simple method..."
            hdiutil create -volname "Pesto Clipboard" -srcfolder dmg-contents -ov -format UDZO "$DMG_NAME"
          fi

          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV

      - name: Calculate SHA256
        id: sha256
        run: |
          SHA256=$(shasum -a 256 "$DMG_NAME" | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ${{ env.DMG_NAME }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Pesto Clipboard v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-alpha') || contains(github.ref, '-rc') }}
          generate_release_notes: true
          files: ${{ env.DMG_NAME }}
          body: |
            ## Installation

            ### Via Homebrew (Recommended)
            ```bash
            brew install --cask pesto-clipboard
            ```

            ### Manual Download
            1. Download `${{ env.DMG_NAME }}` below
            2. Open the DMG and drag Pesto Clipboard to Applications

            ## Verification

            SHA256: `${{ steps.sha256.outputs.SHA256 }}`

            Verify with:
            ```bash
            echo "${{ steps.sha256.outputs.SHA256 }}  ${{ env.DMG_NAME }}" | shasum -a 256 -c
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
